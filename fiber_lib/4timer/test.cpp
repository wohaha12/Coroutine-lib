// ============================================================================
// 定时器模块测试程序
// 用于测试sylar::TimerManager类的基本功能，包括一次性定时器和循环定时器
// ============================================================================
#include "timer.h"
#include <unistd.h>
#include <iostream>
using namespace sylar;

// ============================================================================
// 定时器回调函数
// @param i 整数参数，用于标识不同的定时器任务
// ============================================================================
void func(int i)
{
    std::cout << "i: " << i << std::endl;
}

// ============================================================================
// 主函数
// 测试TimerManager的基本功能：
// 1. 添加多个一次性定时器并等待它们超时
// 2. 添加循环定时器并测试其重复执行特性
// ============================================================================
int main(int argc, char const *argv[])
{
    // 创建定时器管理器实例
    std::shared_ptr<TimerManager> manager(new TimerManager());
    // 用于存储过期定时器回调函数的容器
    std::vector<std::function<void()>> cbs;

    // ========================================================================
    // 测试场景一：listExpiredCb超时功能 - 测试一次性定时器
    // ========================================================================
    {
        std::cout << "测试一次性定时器..." << std::endl;
        // 添加10个一次性定时器，超时时间分别为1秒、2秒、...、10秒
        for(int i=0; i<10; i++)
        {
            // 添加定时器：超时时间(i+1)*1000毫秒，回调函数，非循环
            manager->addTimer((i+1)*1000, std::bind(&func, i), false);
        }
        std::cout << "所有定时器已设置完成" << std::endl;

        // 等待5秒，此时应该有前5个定时器超时
        sleep(5);
        // 获取所有已超时的定时器回调函数
        manager->listExpiredCb(cbs);
        // 执行所有超时回调
        while(!cbs.empty())
        {
            std::function<void()> cb = *cbs.begin();
            cbs.erase(cbs.begin());
            cb();
        }

        // 再等待5秒，此时剩余的定时器应该都超时了
        sleep(5);
        // 获取所有已超时的定时器回调函数
        manager->listExpiredCb(cbs);
        // 执行所有超时回调
        while(!cbs.empty())
        {
            std::function<void()> cb = *cbs.begin();
            cbs.erase(cbs.begin());
            cb();
        }
    }
        
    // ========================================================================
    // 测试场景二：recurring - 测试循环定时器
    // ========================================================================
    {
        std::cout << "测试循环定时器..." << std::endl;
        // 添加一个每秒执行一次的循环定时器
        manager->addTimer(1000, std::bind(&func, 1000), true);
        // 循环10次，每次等待1秒并执行超时回调
        int j = 10;
        while(j-- > 0)
        {
            sleep(1);
            // 获取已超时的定时器回调函数
            manager->listExpiredCb(cbs);
            // 执行回调函数
            std::function<void()> cb = *cbs.begin();
            cbs.erase(cbs.begin());
            cb();
        }
    }
    return 0;
}